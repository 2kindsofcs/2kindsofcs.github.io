---
layout: post
title: "2019-05-12-TIL-db 오류를 고치자"
slug: "190512-TIL"
tags: [TIL]
---

### db가 왜 안돌아가지??  

는 db가 잘 붙긴 붙었는데 어디선가 동작을 안 하는 듯 했다. 먼저 db.js에 asyn cStackTraces: true를 추가해보았다. 에러없이 종료되버리는 게 의심되서 추가한 것이다. 이걸 추가하면 자세하게 에러를 볼 수 있으니까. 비동기 처리라서 이게 없으면 어떤 코드에서 쿼리를 실행시켰는데 에러가 났을 때 그 코드의 위치를 알 수가 없다.  

- db와는 별개로:
내보내는건 studyPoll 함수인데 왜 app(/post)~ 가 작동을하지? 라는 의문이 있었다. 이건 노드js의 모듈 시스템의 동작에 관한 것이다. 처음에 파일을 실행시킬 때 노드는 require 하는 파일이 있으면 그게 기존에 이미 로드가 되어있는지 확인을 하고, 이미 로드 되어있을 경우 캐싱되어 있는 module.exports를 제공한다. 로드가 되어있지 않을 경우 해당 파일을 처음부터 쭉 실행하고 module.exports를 마찬가지로 제공한다. 즉 사실 최초로 index.js를 실행시켰을 때 studyPoll을 require하고 있으므로 해당 파일의 코드가 실행되었던 것이었다!   

- 함수와 프로시져
프로시져. 말 그대로 코드 블록. 코드 덩어리. 일종의 절차. 함수는 인풋과 아웃풋이 있다. 즉, 리턴값이 있다. 예전에 봤던 어떤 책에서는 "리턴값이 없는 함수도 있다"라는 표현을 썼는데, 사실 그건 프로시져인 것이다. (파이썬으로 치면 "헬로 월드" 프린트 하고 아무 일도 하지 않는 함수) 다들 편하게 넓은 의미로서 프로시져까지 포함해서 함수라고 부르는 것이다.  

- db 고침. 
원인은 아래 코드에 있었다.  

{% raw %}
```javascript
if (await db('round_info').where({study_date: dateString}).count('*') !== 0) {
    return;
  }
```
{% endraw %}

채팅방에 "수요조사 나왔습니다!" 하고 메세지를 뿌리기 전에 이미 메세지를 뿌렸는지를 확인하고 싶은 것이다. 그래서 round_info 테이블에 해당 스터디 날짜의 정보(정확히는 행, 날짜 및 가격)가 있는지 확인하려고 했다. 따라서 이미 있으면 1, 없으면 0이 나와야 한다. 만약 0이 아닐 경우(즉 이미 데이터가 있을 경우) 메세지를 뿌리지 않아도 되므로 바로 return으로 함수를 빠져나오려고 했던 것이다.  

그랬는데......  

사실 저 쿼리의 결과값은 [ {'count(*)':0} ] 였다...! 
<del> 그러니 작동을 안하지 </del>
따라서 코드를 아래와 같이 고쳐주었다.

{% raw %}
```javascript
const roundCount = await db('round_info').where(
    {study_date: dateString}
  ).count('*');
if (roundCount[0]['count(*)'] !== 0) {
  console.log(`이미 있단다 깔깔깔`);
  return;
}
```
{% endraw %}

원하는 데이터가 배열 안의 객체 안의 특정 키의 밸류값이므로 그것을 찾아서 0인지 아닌지 확인하는 것으로 바꿔주었다. 이러한 연유로 계속 의도치 않게 return으로 빠져나가서 마치 db가 작동하지 않는 것처럼 보였던 것이었다. <del> 미스테리가 풀렸다 </del>  

- 전역변수가 왜 나쁜가요? 
추적하기가 어렵다. 누구 때문에 변경이 되서 왜 이런 값을 갖고 있는지를 확인하기가 굉장히 어려워진다. 
따라서 가급적 전역 변수 만들어놓고 각 함수에서 접근해서 쓰기 보다, 정 필요하면 한 함수가 다른 함수에게 인자로 넘겨주는 식으로 쓰는 것이 좋다. 그래야 나쁜 짓을 한 친구를 쉽게 알아낼 수 있다.  

#### 기타
- 윈도우 탐색기 주소창에 그냥 cmd 하면 해당 디렉토리에서 cmd를 열게 됨 
- 내어쓰기 하고 싶으면 블록 선택한 다음 shift+tab